# clab: claude with full lab vault access, skip permissions
# Usage: clab [extra claude args...]
clab() {
    local lab="${LAB_VAULT:-$HOME/docs/lab}"
    claude --dangerously-skip-permissions \
        --add-dir "$lab" \
        "$@"
}

# crlab: claude with full lab vault access, skip permissions, remote control
# Usage: crlab [extra claude args...]
crlab() {
    local lab="${LAB_VAULT:-$HOME/docs/lab}"
    claude remote-control --dangerously-skip-permissions \
        --add-dir "$lab" \
        "$@"
}

# gpm: quick add-commit-push (safer version)
# Requires a commit message. Uses current branch, not hardcoded main.
gpm() {
    if [ -z "$1" ]; then
        echo "Usage: gpm \"commit message\""
        return 1
    fi
    git add -A && git commit -m "$1" && git push
}

# obs-daily: create (if needed) and open a daily note (default: today)
# Usage: obs-daily [YYYY-MM-DD]
obs-daily() {
    if [ -z "$LIFE_VAULT" ]; then
        echo "LIFE_VAULT is not set"
        return 1
    fi
    local day=${1:-$(date +%Y-%m-%d)}
    local year=${day%%-*}
    local month=${day#*-}; month=${month%%-*}
    local weekday=$(date -j -f %Y-%m-%d "$day" +%A 2>/dev/null \
                 || date -d "$day" +%A)
    local dir="$LIFE_VAULT/Days/$year/$month"
    local file="$dir/$day.md"

    mkdir -p "$dir"
    if [ ! -f "$file" ]; then
        cat > "$file" <<EOF
#days
$weekday
Morning:

Afternoon:

Evening:

EOF
        echo "Created $file"
    fi
    ${EDITOR:-vim} "$file"
}

# og: ripgrep across vault markdown files
og() {
    if [ -z "$1" ]; then
        echo "Usage: og <pattern> [lab|life]"
        return 1
    fi
    local vault_path
    case "${2:-lab}" in
        lab)  vault_path="$LAB_VAULT" ;;
        life) vault_path="$LIFE_VAULT" ;;
        *)    vault_path="$2" ;;
    esac
    if [ -z "$vault_path" ]; then
        echo "Vault path not set. Check ~/.dotfiles.local"
        return 1
    fi
    rg --type md "$1" "$vault_path"
}

# mc: copy stdin to local clipboard via OSC 52 (works over SSH + tmux)
mc() {
    local input
    input=$(cat)
    if [ -n "$TMUX" ]; then
        printf '\ePtmux;\e\e]52;c;%s\a\e\\' "$(printf '%s' "$input" | base64 | tr -d '\n')"
    else
        printf '\e]52;c;%s\a' "$(printf '%s' "$input" | base64 | tr -d '\n')"
    fi
}

# changetheme: switch Ghostty theme + write state for nvim (macOS only)
if [ "$(uname)" = "Darwin" ]; then
    changetheme() {
        local CONFIG_PATH="$HOME/.config/ghostty/config"
        local STATE_FILE="$HOME/.local/state/theme"
        local fg bg theme desc

        case "$1" in
            d) fg="ffffff"; bg="000000"; theme="dark";  desc="dark (white on black)" ;;
            m) fg="cdd6f4"; bg="1e1e2e"; theme="dark";  desc="mocha (catppuccin)" ;;
            w) fg="000000"; bg="ffffff"; theme="light"; desc="light (black on white)" ;;
            c) fg="000000"; bg="F0EEE4"; theme="cream"; desc="cream (black on cream)" ;;
            *)
                echo "Usage: changetheme [d|m|w|c]"
                echo "  d - dark    m - mocha    w - light    c - cream"
                return ;;
        esac

        local temp_file=$(mktemp)
        while IFS= read -r line; do
            if [[ $line == "foreground ="* ]]; then
                echo "foreground = #$fg"
            elif [[ $line == "background ="* ]]; then
                echo "background = #$bg"
            else
                echo "$line"
            fi
        done < "$CONFIG_PATH" > "$temp_file"

        cat "$temp_file" > "$CONFIG_PATH"
        rm "$temp_file"
        mkdir -p "$(dirname "$STATE_FILE")"
        echo "$theme" > "$STATE_FILE"
        # Update current terminal via OSC (other windows: Cmd+Shift+, to reload config)
        printf '\e]10;#%s\e\\\e]11;#%s\e\\' "$fg" "$bg"
        echo "Applied: $desc"
    }
    alias ct='changetheme'
fi

# try (run try.rb directly â€” gem wrapper breaks __FILE__ == $0 guard)
# macOS/Homebrew only; uses [ -f ] check which works in both bash and zsh
if [ -d /opt/homebrew/lib/ruby ]; then
    for _f in /opt/homebrew/lib/ruby/gems/*/gems/try-cli-*/try.rb; do
        [ -f "$_f" ] && eval "$(/opt/homebrew/opt/ruby/bin/ruby "$_f" init "$HOME/src/tries")" && break
    done
    unset _f
fi
